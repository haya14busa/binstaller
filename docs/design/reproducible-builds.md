---
title: "Reproducible Builds"
date: "2025-04-18"
author: "goinstaller team"
version: "0.1.0"
status: "draft"
---

# Reproducible Builds for goinstaller

## Overview

This document outlines the design and implementation of reproducible builds for goinstaller. The goal is to ensure that the generated installer scripts are deterministic and reproducible, which enhances auditability and reliability.

## Problem Statement

Currently, the goinstaller tool includes a timestamp in the generated installer scripts:

```sh
# Code generated by godownloader on 2025-04-18T11:19:56Z. DO NOT EDIT.
```

This timestamp changes with each generation, making it impossible to reproduce the exact same installer script even when using the same input configuration. This non-deterministic behavior can cause issues with:

1. **Auditability**: It's difficult to verify that a script was generated from a specific configuration file.
2. **Reliability**: Different builds of the same configuration can produce different scripts, potentially leading to confusion.
3. **Version Control**: Unnecessary diffs in version control systems due to timestamp changes.

## Proposed Solution

Replace the timestamp with deterministic information about the source:

1. For GitHub repositories:
   ```sh
   # Code generated by godownloader from github.com/owner/repo@abc123 (commit hash). DO NOT EDIT.
   ```

2. For local files:
   ```sh
   # Code generated by godownloader from /path/to/file@abc123 (file hash). DO NOT EDIT.
   ```

This approach ensures that the same input configuration will always produce the same installer script, making builds reproducible.

## Implementation Details

### Changes to Data Structures

1. Add a `SourceInfo` field to the `TemplateContext` struct:

```go
type TemplateContext struct {
    *config.Project
    EnableGHAttestation      bool
    RequireAttestation       bool
    GHAttestationVerifyFlags string
    SourceInfo               string // New field for source information
}
```

### Changes to Functions

1. Update `processGodownloader` to calculate and include the source information:
   - For GitHub repos: Get the repo name and commit hash
   - For local files: Calculate the file hash

2. Update `makeShell` to replace the timestamp function with a function that returns the source information:

```go
"sourceInfo": func() string {
    return ctx.SourceInfo
},
```

3. Update the shell script template to use the new source information:

```sh
# Code generated by godownloader from {{ sourceInfo }}. DO NOT EDIT.
```

### Algorithm for Source Information

#### For GitHub Repositories

1. Use the repository name (already available)
2. Use the default branch (already implemented)
3. Get the commit hash of the configuration file
   - This will require making an API call to GitHub to get the commit hash

#### For Local Files

1. Use the file path (already available)
2. Calculate a SHA-256 hash of the file content

## Benefits

1. **Auditability**: Users can verify that a script was generated from a specific configuration file.
2. **Reliability**: The same configuration will always produce the same script.
3. **Version Control**: No unnecessary diffs due to timestamp changes.

## Limitations

1. For GitHub repositories, we need to make an additional API call to get the commit hash.
2. For local files, the hash will change if the file content changes.

## Future Work

1. Consider adding a command-line flag to disable the source information for users who prefer not to include it.
2. Explore other ways to make the build process more reproducible.